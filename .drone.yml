kind: pipeline
type: docker
name: build-and-deploy-portfolio-siwa

trigger:
  branch:
    - main
  event:
    - push

steps:
  - name: "ğŸ” vÃ©rification"
    image: mcr.microsoft.com/dotnet/sdk:9.0
    commands:
      - echo "ğŸ” [INFO] VÃ©rification du projet .NET..."
      - dotnet restore portfolio_siwa/portfolio_siwa.csproj || {
          echo "âŒ [ERROR] Restauration des dÃ©pendances Ã©chouÃ©e.";
          exit 1;
        }
      - dotnet build portfolio_siwa/portfolio_siwa.csproj -c Release || {
          echo "âŒ [ERROR] Build Ã©chouÃ©.";
          exit 1;
        }
      - echo "âœ… [SUCCESS] VÃ©rification rÃ©ussie."

  # - name: "ğŸ“¦ tests"
  #   depends_on:
  #     - "ğŸ” vÃ©rification"
  #   image: mcr.microsoft.com/dotnet/sdk:9.0
  #   volumes:
  #     - name: shared-volume
  #       path: /shared
  #   commands:
  #     - echo "ğŸ§ª [INFO] Lancement des tests unitaires..."
  #     - mkdir -p /shared/test-results
  #     - dotnet test tests/tests.csproj --configuration Release /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:CoverletOutput=/shared/test-results/coverage /p:MergeWith=/shared/test-results/coverage.json --logger:"trx" || { echo "âŒ [ERROR] Tests Ã©chouÃ©s !"; exit 1; }
  #     - echo "âœ… [SUCCESS] Tests terminÃ©s avec succÃ¨s."

  - name: "ğŸ“¦ tests"
    depends_on:
      - "ğŸ” vÃ©rification"
    image: mcr.microsoft.com/dotnet/sdk:9.0
    volumes:
      - name: shared-volume
        path: /shared
    commands:
      - echo "ğŸ§ª [INFO] Lancement des tests unitaires..." && mkdir -p /shared/test-results && dotnet test portfolio_siwa.sln --configuration Release /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:CoverletOutput=/shared/test-results/coverage.opencover.xml --logger:"trx" || { echo "âŒ [ERROR] Tests Ã©chouÃ©s !"; exit 1; }
      - echo "ğŸ“‚ [INFO] Fichiers de couverture gÃ©nÃ©rÃ©s :" && find /shared/test-results -type f



  - name: "ğŸ” sonar-analyse"
    image: mcr.microsoft.com/dotnet/sdk:9.0
    depends_on:
      - "ğŸ“¦ tests"
    environment:
      SONAR_HOST_URL: https://sonar.davalada.valorium-mc.fr
      SONAR_TOKEN:
        from_secret: SONAR_TOKEN
    volumes:
      - name: shared-volume
        path: /shared
    commands:
      - apt-get update && apt-get install -y openjdk-17-jre && export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64 && export PATH=$JAVA_HOME/bin:$PATH && dotnet tool install --global dotnet-sonarscanner && export PATH="$PATH:/root/.dotnet/tools" && echo "ğŸš€ [INFO] Initialisation Sonar..." && dotnet-sonarscanner begin /k:portfolio-siwa /s:portfolio_siwa.sln /d:sonar.host.url=$SONAR_HOST_URL /d:sonar.login=$SONAR_TOKEN /d:sonar.cs.opencover.reportsPaths=/shared/test-results/coverage.opencover.xml && echo "ğŸ§± [INFO] Build de la solution..." && dotnet build portfolio_siwa.sln --no-incremental && echo "âœ… [INFO] Fin de lâ€™analyse Sonar..." && dotnet-sonarscanner end /d:sonar.login=$SONAR_TOKEN



  # - name: "ğŸ” sonar-analyse"
  #   image: mcr.microsoft.com/dotnet/sdk:9.0
  #   depends_on:
  #     - "ğŸ“¦ tests"
  #   environment:
  #     SONAR_HOST_URL: https://sonar.davalada.valorium-mc.fr
  #     SONAR_TOKEN:
  #       from_secret: SONAR_TOKEN
  #   volumes:
  #     - name: shared-volume
  #       path: /shared
  #   commands:
  #     - apt-get update && apt-get install -y openjdk-17-jre
  #     - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
  #     - export PATH=$JAVA_HOME/bin:$PATH

  #     - echo "ğŸ” [INFO] Installation de SonarScanner..."
  #     - dotnet tool install --global dotnet-sonarscanner
  #     - export PATH="$PATH:/root/.dotnet/tools"

  #     - echo "ğŸš€ [INFO] Initialisation Sonar..."
  #     - dotnet-sonarscanner begin /k:portfolio-siwa /d:sonar.host.url=$SONAR_HOST_URL /d:sonar.login=$SONAR_TOKEN /d:sonar.cs.opencover.reportsPaths=/shared/test-results/coverage.opencover.xml

  #     - echo "ğŸ§± [INFO] Build du projet principal..."
  #     - dotnet build portfolio_siwa/portfolio_siwa.csproj --no-incremental

  #     - echo "âœ… [INFO] Fin de lâ€™analyse Sonar..."
  #     - dotnet-sonarscanner end /d:sonar.login=$SONAR_TOKEN

  #     - echo "âœ… [SUCCESS] Analyse SonarQube terminÃ©e avec succÃ¨s."



  - name: "ğŸ³ build-and-push"
    depends_on:
      - "ğŸ“¦ tests"
    image: plugins/docker
    settings:
      registry: registry.devalada.valorium-mc.fr
      repo: registry.devalada.valorium-mc.fr/portfolio-siwa
      username:
        from_secret: DOCKER_USERNAME
      password:
        from_secret: DOCKER_PASSWORD
      no_cache: true
      tags:
        - latest
      dockerfile: Dockerfile

  - name: "ğŸš€ deploy-vps"
    image: appleboy/drone-ssh
    depends_on:
      - "ğŸ³ build-and-push"
    settings:
      host: ecirada.valorium-mc.fr
      port: 22
      username:
        from_secret: SSH_USER
      ssh_key:
        from_secret: SSH_PRIVATE_KEY
      script:
        - echo "ğŸš€ [INFO] DÃ©ploiement de portfolio_siwa en cours..."
        - cd deploiements/portfolio-siwa/
        - echo "ğŸ›‘ [INFO] ArrÃªt de l'ancien conteneur..."
        - docker compose down
        - echo "ğŸ“¥ [INFO] Pull de la derniÃ¨re image depuis le registry..."
        - docker compose pull
        - echo "ğŸš€ [INFO] DÃ©marrage du nouveau conteneur..."
        - docker compose up -d
        - sleep 5
        - docker ps | grep portfolio_siwa || {
            echo "âŒ [ERROR] Le service ne tourne pas !";
            exit 1;
          }
        - echo "âœ… [SUCCESS] DÃ©ploiement terminÃ© avec succÃ¨s."


volumes:
  - name: shared-volume
    temp: {}
