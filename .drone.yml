kind: pipeline
type: docker
name: build-and-deploy-portfolio-siwa-main

trigger:
  branch:
    - main
  event:
    - push

volumes:
  - name: shared-volume
    temp: {}

steps:
  - name: "ğŸ›  build"
    image: mcr.microsoft.com/dotnet/sdk:9.0
    commands:
      - echo "ğŸ›  [INFO] Build du projet portfolio_siwa..."
      - dotnet publish ./portfolio_siwa/portfolio_siwa.csproj -c Release -o out || {
          echo "âŒ [ERROR] Le build a Ã©chouÃ©.";
          exit 1;
        }
      - echo "âœ… [SUCCESS] Build terminÃ©."

  - name: "ğŸ§ª tests-unitaires"
    image: mcr.microsoft.com/dotnet/sdk:9.0
    volumes:
      - name: shared-volume
        path: /coverage
    commands:
      - echo "ğŸ§ª [INFO] Lancement des tests avec couverture..."
      - dotnet test ./portfolio_siwa.sln --configuration Release --collect:"XPlat Code Coverage" --results-directory /coverage --logger "console;verbosity=normal" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover || { echo "âŒ [ERROR] Les tests ont Ã©chouÃ©."; exit 1; }
      - echo "ğŸ” [DEBUG] Fichier opencover.xml gÃ©nÃ©rÃ© (dÃ©but) :"
      - COVERAGE_FILE=$(find /coverage -name *.opencover.xml | head -n 1)
      - cat "$COVERAGE_FILE" | head -n 30
      - echo "ğŸ“¦ [INFO] Renommage pour Sonar..."
      - mv "$COVERAGE_FILE" /coverage/opencover.xml
      - echo "âœ… [SUCCESS] Tests terminÃ©s avec couverture."

  - name: "ğŸ“Š analyse-sonar"
    image: mcr.microsoft.com/dotnet/sdk:9.0
    environment:
      SONAR_HOST_URL: https://sonar.davalada.valorium-mc.fr
      SONAR_TOKEN:
        from_secret: SONAR_TOKEN
    volumes:
      - name: shared-volume
        path: /coverage
    commands:
      - echo "ğŸ“Š [INFO] Initialisation de l'analyse Sonar..."
      - apt-get update && apt-get install -y openjdk-17-jre
      - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64 && export PATH=$JAVA_HOME/bin:$PATH
      - dotnet tool install --global dotnet-sonarscanner
      - export PATH="$PATH:/root/.dotnet/tools"
      - echo "ğŸ” [DEBUG] VÃ©rification du fichier opencover.xml avant analyse..."
      - find /coverage -name *.opencover.xml || true
      - head -n 30 /coverage/opencover.xml
      - dotnet-sonarscanner begin /k:portfolio-siwa /d:sonar.host.url=$SONAR_HOST_URL /d:sonar.login=$SONAR_TOKEN /d:sonar.cs.opencover.reportsPaths=/coverage/**/opencover.xml /d:sonar.sources=./portfolio_siwa
      - dotnet build ./portfolio_siwa/portfolio_siwa.csproj --no-incremental
      - dotnet-sonarscanner end /d:sonar.login=$SONAR_TOKEN
      - echo "âœ… [SUCCESS] Analyse Sonar terminÃ©e."

  - name: "ğŸ³ build-et-push-image"
    image: plugins/docker
    depends_on: [ "ğŸ›  build", "ğŸ§ª tests-unitaires" ]
    settings:
      registry: registry.devalada.valorium-mc.fr
      repo: registry.devalada.valorium-mc.fr/portfolio-siwa-main
      username:
        from_secret: DOCKER_USERNAME
      password:
        from_secret: DOCKER_PASSWORD
      dockerfile: Dockerfile
      tags:
        - latest

  - name: "ğŸš€ deploiement-vps-main"
    image: appleboy/drone-ssh
    depends_on:
      - "ğŸ³ build-et-push-image"
    settings:
      host: ecirada.valorium-mc.fr
      username:
        from_secret: SSH_USER
      ssh_key:
        from_secret: SSH_PRIVATE_KEY
      port: 22
      script:
        - echo "ğŸš€ [INFO] DÃ©ploiement en cours..."
        - cd deploiements/portfolio/portfolio-siwa-main
        - echo "ğŸ›‘ [INFO] ArrÃªt de l'ancien service..."
        - docker compose down
        - echo "ğŸ“¥ [INFO] Pull de la nouvelle image..."
        - docker compose pull
        - echo "ğŸš€ [INFO] Relancement du service..."
        - docker compose up -d
        - sleep 5
        - docker ps | grep portfolio-siwa-main || {
            echo "âŒ [ERROR] Le service ne tourne pas !";
            exit 1;
          }
        - echo "âœ… [SUCCESS] DÃ©ploiement terminÃ©."






# kind: pipeline
# type: docker
# name: build-and-deploy-portfolio-siwa

# trigger:
#   branch:
#     - main
#   event:
#     - push

# steps:
#   - name: "ğŸ” vÃ©rification"
#     image: mcr.microsoft.com/dotnet/sdk:9.0
#     commands:
#       - echo "ğŸ” [INFO] VÃ©rification du projet .NET..."
#       - dotnet restore portfolio_siwa/portfolio_siwa.csproj || {
#           echo "âŒ [ERROR] Restauration des dÃ©pendances Ã©chouÃ©e.";
#           exit 1;
#         }
#       - dotnet build portfolio_siwa/portfolio_siwa.csproj -c Release || {
#           echo "âŒ [ERROR] Build Ã©chouÃ©.";
#           exit 1;
#         }
#       - echo "âœ… [SUCCESS] VÃ©rification rÃ©ussie."

#   - name: "ğŸ“¦ tests"
#     depends_on:
#       - "ğŸ” vÃ©rification"
#     image: mcr.microsoft.com/dotnet/sdk:9.0
#     volumes:
#       - name: shared-volume
#         path: /shared
#     commands:
#       - echo "ğŸ§ª [INFO] Lancement des tests unitaires..."
#       - mkdir -p /shared/test-results
#       - dotnet test portfolio_siwa.sln --configuration Release /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:CoverletOutput=/shared/test-results/coverage.opencover.xml --logger:"trx" || { echo "âŒ [ERROR] Tests Ã©chouÃ©s !"; exit 1; }
#       - echo "ğŸ“‚ [INFO] Fichiers de couverture gÃ©nÃ©rÃ©s :"
#       - find /shared/test-results -type f

#   - name: "ğŸ” sonar-analyse"
#     image: mcr.microsoft.com/dotnet/sdk:9.0
#     depends_on:
#       - "ğŸ“¦ tests"
#     environment:
#       SONAR_HOST_URL: https://sonar.davalada.valorium-mc.fr
#       SONAR_TOKEN:
#         from_secret: SONAR_TOKEN
#     volumes:
#       - name: shared-volume
#         path: /shared
#     commands:
#       - apt-get update
#       - apt-get install -y openjdk-17-jre
#       - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
#       - export PATH=$JAVA_HOME/bin:$PATH
#       - dotnet tool install --global dotnet-sonarscanner
#       - export PATH="$PATH:/root/.dotnet/tools:$PATH"
#       - echo "ğŸš€ [INFO] Initialisation Sonar..."
#       - dotnet-sonarscanner begin /k:portfolio-siwa /d:sonar.host.url=$SONAR_HOST_URL /d:sonar.login=$SONAR_TOKEN /d:sonar.cs.opencover.reportsPaths=/shared/test-results/coverage.opencover.xml
#       - echo "ğŸ§± [INFO] Build de la solution..."
#       - dotnet build portfolio_siwa.sln --no-incremental
#       - echo "âœ… [INFO] Fin de lâ€™analyse Sonar..."
#       - dotnet-sonarscanner end /d:sonar.login=$SONAR_TOKEN

#   - name: "ğŸ³ build-and-push"
#     depends_on:
#       - "ğŸ“¦ tests"
#     image: plugins/docker
#     settings:
#       registry: registry.devalada.valorium-mc.fr
#       repo: registry.devalada.valorium-mc.fr/portfolio-siwa
#       username:
#         from_secret: DOCKER_USERNAME
#       password:
#         from_secret: DOCKER_PASSWORD
#       no_cache: true
#       tags:
#         - latest
#       dockerfile: Dockerfile

#   - name: "ğŸš€ deploy-vps"
#     image: appleboy/drone-ssh
#     depends_on:
#       - "ğŸ³ build-and-push"
#     settings:
#       host: ecirada.valorium-mc.fr
#       port: 22
#       username:
#         from_secret: SSH_USER
#       ssh_key:
#         from_secret: SSH_PRIVATE_KEY
#       script:
#         - echo "ğŸš€ [INFO] DÃ©ploiement de portfolio_siwa en cours..."
#         - cd deploiements/portfolio-siwa/
#         - echo "ğŸ›‘ [INFO] ArrÃªt de l'ancien conteneur..."
#         - docker compose down
#         - echo "ğŸ“¥ [INFO] Pull de la derniÃ¨re image depuis le registry..."
#         - docker compose pull
#         - echo "ğŸš€ [INFO] DÃ©marrage du nouveau conteneur..."
#         - docker compose up -d
#         - sleep 5
#         - docker ps | grep portfolio_siwa || {
#             echo "âŒ [ERROR] Le service ne tourne pas !";
#             exit 1;
#           }
#         - echo "âœ… [SUCCESS] DÃ©ploiement terminÃ© avec succÃ¨s."


# volumes:
#   - name: shared-volume
#     temp: {}
